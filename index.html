
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com\0xor1\sus\file.go (100.0%)</option>
				
				<option value="file1">github.com\0xor1\sus\gae.go (0.0%)</option>
				
				<option value="file2">github.com\0xor1\sus\local_memory.go (100.0%)</option>
				
				<option value="file3">github.com\0xor1\sus\mutex_byte.go (100.0%)</option>
				
				<option value="file4">github.com\0xor1\sus\sus.go (100.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" >package sus

import(
        `os`
        `io/ioutil`
        `golang.org/x/net/context`
)

func NewJsonFileStore(storeDir string, idf IdFactory, vf VersionFactory) (VersionStore, error) <span class="cov8" title="1">{
        return NewFileStore(storeDir, `json`, jsonMarshaler, jsonUnmarshaler, idf, vf)
}</span>

func NewFileStore(storeDir string, fileExt string, m Marshaler, un Unmarshaler, idf IdFactory, vf VersionFactory) (VersionStore, error) <span class="cov8" title="1">{
        err := os.MkdirAll(storeDir, os.ModeDir)

        if err == nil </span><span class="cov8" title="1">{

                getFileName := func(id string) string </span><span class="cov8" title="1">{
                        return storeDir + `/` + id + `.` + fileExt
                }</span>

                <span class="cov8" title="1">get := func(ctx context.Context, id string) ([]byte, error) </span><span class="cov8" title="1">{
                        fn := getFileName(id)
                        if _, err := os.Stat(fn); err != nil </span><span class="cov8" title="1">{
                                if os.IsNotExist(err) </span><span class="cov8" title="1">{
                                        err = EntityDoesNotExist
                                }</span>
                                <span class="cov8" title="1">return nil, err</span>
                        }
                        <span class="cov8" title="1">return ioutil.ReadFile(fn)</span>
                }

                <span class="cov8" title="1">put := func(ctx context.Context, id string, d []byte) error </span><span class="cov8" title="1">{
                        return ioutil.WriteFile(getFileName(id), d, os.ModeAppend)
                }</span>

                <span class="cov8" title="1">del := func(ctx context.Context, id string) error </span><span class="cov8" title="1">{
                        return os.Remove(getFileName(id))
                }</span>

                <span class="cov8" title="1">return NewMutexByteStore(get, put, del, m, un, idf, vf), nil</span>
        }

        <span class="cov8" title="1">return nil, err</span>
}</pre>
		
		<pre class="file" id="file1" style="display: none">package sus

import(
        `github.com/qedus/nds`
        `golang.org/x/net/context`
        `google.golang.org/appengine/datastore`
)

func NewGaeStore(kind string, idf IdFactory, vf VersionFactory) VersionStore <span class="cov0" title="0">{
        getKey := func(ctx context.Context, id string) *datastore.Key </span><span class="cov0" title="0">{
                return datastore.NewKey(ctx, kind, id, 0, nil)
        }</span>

        <span class="cov0" title="0">get := func(ctx context.Context, id string) (v Version, err error) </span><span class="cov0" title="0">{
                v = vf()
                key := getKey(ctx, id)
                err = nds.Get(ctx, key, v)
                return
        }</span>

        <span class="cov0" title="0">put := func(ctx context.Context, id string, v Version) (err error) </span><span class="cov0" title="0">{
                key := getKey(ctx, id)
                _, err = nds.Put(ctx, key, v)
                return
        }</span>

        <span class="cov0" title="0">del := func(ctx context.Context, id string) error </span><span class="cov0" title="0">{
                key := getKey(ctx, id)
                return nds.Delete(ctx, key)
        }</span>

        <span class="cov0" title="0">rit := func(ctx context.Context, tran Transaction) error </span><span class="cov0" title="0">{
                return nds.RunInTransaction(ctx, tran, &amp;datastore.TransactionOptions{XG:false})
        }</span>

        <span class="cov0" title="0">return NewVersionStore(get, put, del, idf, vf, rit)</span>
}</pre>
		
		<pre class="file" id="file2" style="display: none">package sus

import(
        `golang.org/x/net/context`
)

func NewJsonLocalMemoryStore(idf IdFactory, vf VersionFactory) VersionStore <span class="cov8" title="1">{
        return NewLocalMemoryStore(jsonMarshaler, jsonUnmarshaler, idf, vf)
}</span>

func NewLocalMemoryStore(m Marshaler, un Unmarshaler, idf IdFactory, vf VersionFactory) VersionStore <span class="cov8" title="1">{
        store := map[string][]byte{}

        get := func(ctx context.Context, id string) ([]byte, error) </span><span class="cov8" title="1">{
                var err error
                d, exists := store[id]
                if !exists </span><span class="cov8" title="1">{
                        err = EntityDoesNotExist
                }</span>
                <span class="cov8" title="1">return d, err</span>
        }

        <span class="cov8" title="1">put := func(ctx context.Context, id string, d []byte) error </span><span class="cov8" title="1">{
                store[id] = d
                return nil
        }</span>

        <span class="cov8" title="1">del := func(ctx context.Context, id string) error </span><span class="cov8" title="1">{
                delete(store, id)
                return nil
        }</span>

        <span class="cov8" title="1">return NewMutexByteStore(get, put, del, m, un, idf, vf)</span>
}</pre>
		
		<pre class="file" id="file3" style="display: none">package sus

import(
        `sync`
        `golang.org/x/net/context`
)

type Marshaler func(src Version) ([]byte, error)
type Unmarshaler func(data []byte, dst Version) error
type ByteGetter func(ctx context.Context, id string) ([]byte, error)
type BytePutter func(ctx context.Context, id string, d []byte) error

func NewMutexByteStore(bg ByteGetter, bp BytePutter, d Delete, m Marshaler, un Unmarshaler, idf IdFactory, vf VersionFactory) VersionStore <span class="cov8" title="1">{
        mtx := sync.Mutex{}

        get := func(ctx context.Context, id string) (v Version, err error) </span><span class="cov8" title="1">{
                d, err := bg(ctx, id)
                if err == nil </span><span class="cov8" title="1">{
                        v = vf()
                        err = un(d, v)
                }</span>
                <span class="cov8" title="1">return</span>
        }

        <span class="cov8" title="1">put := func(ctx context.Context, id string, v Version) error </span><span class="cov8" title="1">{
                d, err := m(v)
                if err == nil </span><span class="cov8" title="1">{
                        err = bp(ctx, id, d)
                }</span>
                <span class="cov8" title="1">return err</span>
        }

        <span class="cov8" title="1">del := func(ctx context.Context, id string) error </span><span class="cov8" title="1">{
                return d(ctx, id)
        }</span>

        <span class="cov8" title="1">rit := func(ctx context.Context, tran Transaction) error </span><span class="cov8" title="1">{
                mtx.Lock()
                defer mtx.Unlock()
                return tran(ctx)
        }</span>

        <span class="cov8" title="1">return NewVersionStore(get, put, del, idf, vf, rit)</span>
}</pre>
		
		<pre class="file" id="file4" style="display: none">package sus

import(
        `errors`
        `encoding/json`
        `golang.org/x/net/context`
)

var(
        EntityDoesNotExist = errors.New(`entity does not exist`)
        NonsequentialUpdate = errors.New(`nonsequential update`)
)

type Version interface{
        getVersion() int
        incrementVersion()
}

func NewVersion() Version <span class="cov8" title="1">{
        vi := version(0)
        return &amp;vi
}</span>

type version int

func (vi *version) getVersion() int<span class="cov8" title="1">{
        return int(*vi)
}</span>

func (vi *version) incrementVersion() <span class="cov8" title="1">{
        *vi = *vi + 1
}</span>

type VersionStore interface{
        Create(ctx context.Context) (id string, v Version, err error)
        Read(ctx context.Context, id string) (v Version, err error)
        Update(ctx context.Context, id string, v Version) error
        Delete(ctx context.Context, id string) error
}

type IdFactory func() string
type VersionFactory func() Version
type RunInTransaction func(ctx context.Context, tran Transaction) error
type Transaction func(ctx context.Context) error
type Get func(ctx context.Context, id string) (Version, error)
type Put func(ctx context.Context, id string, v Version) error
type Delete func(ctx context.Context, id string) error

func NewVersionStore(g Get, p Put, d Delete, idf IdFactory, vf VersionFactory, rit RunInTransaction) VersionStore <span class="cov8" title="1">{
        return &amp;versionStore{g, p, d, idf, vf, rit}
}</span>

type versionStore struct{
        get                                 Get
        put                                 Put
        delete                                 Delete
        idFactory                         IdFactory
        versionFactory                 VersionFactory
        runInTransaction        RunInTransaction
}

func (vs *versionStore) Create(ctx context.Context) (id string, v Version, err error) <span class="cov8" title="1">{
        err = vs.runInTransaction(ctx, func(ctx context.Context) error </span><span class="cov8" title="1">{
                id = vs.idFactory()
                v = vs.versionFactory()
                return vs.put(ctx, id, v)
        }</span>)
        <span class="cov8" title="1">return</span>
}

func (vs *versionStore) Read(ctx context.Context, id string) (v Version, err error) <span class="cov8" title="1">{
        err = vs.runInTransaction(ctx, func(ctx context.Context) error </span><span class="cov8" title="1">{
                v, err = vs.get(ctx, id)
                return err
        }</span>)
        <span class="cov8" title="1">return</span>
}

func (vs *versionStore) Update(ctx context.Context, id string, v Version) (err error) <span class="cov8" title="1">{
        err = vs.runInTransaction(ctx, func(ctx context.Context) error </span><span class="cov8" title="1">{
                oldV, err := vs.get(ctx, id)
                if err == nil </span><span class="cov8" title="1">{
                        if oldV.getVersion() != v.getVersion() </span><span class="cov8" title="1">{
                                err = NonsequentialUpdate
                        }</span><span class="cov8" title="1"> else {
                                v.incrementVersion()
                                err = vs.put(ctx, id, v)
                        }</span>
                }
                <span class="cov8" title="1">return err</span>
        })
        <span class="cov8" title="1">return</span>
}

func (vs *versionStore) Delete(ctx context.Context, id string) (err error) <span class="cov8" title="1">{
        err = vs.runInTransaction(ctx, func(ctx context.Context) error </span><span class="cov8" title="1">{
                return vs.delete(ctx, id)
        }</span>)
        <span class="cov8" title="1">return</span>
}

func jsonMarshaler(v Version)([]byte, error)<span class="cov8" title="1">{
        return json.Marshal(v)
}</span>

func jsonUnmarshaler(d []byte, v Version) error<span class="cov8" title="1">{
        return json.Unmarshal(d, v)
}</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible = document.getElementById('file0');
		files.addEventListener('change', onChange, false);
		function onChange() {
			visible.style.display = 'none';
			visible = document.getElementById(files.value);
			visible.style.display = 'block';
			window.scrollTo(0, 0);
		}
	})();
	</script>
</html>
